# CICD

### Part 1. Setting up the **gitlab-runner**

![Проверка ОС виртуальной машины](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled.png)

Проверка ОС виртуальной машины

![Скачивание gitlab-runner по инструкции](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%201.png)

Скачивание gitlab-runner по инструкции

![`Установка sudo apt-get install gitlab-runner`](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%202.png)

`Установка sudo apt-get install gitlab-runner`

![Регистрация gitlab-runner с помощью токена, данного в задании](CICD%20ce3fed91822c4e44a411f92108d92094/91d0563b-754c-44e0-a197-186a9132c07c.png)

Регистрация gitlab-runner с помощью токена, данного в задании

![Перезагрузка gitlab-runner’a и подтверждение, что сервис работает](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%203.png)

Перезагрузка gitlab-runner’a и подтверждение, что сервис работает

Устанавливаем на виртуальную машину необходимые пакеты:

```
sudo apt install make -y gcc -y g++ -y valgrind -y clang -y libpcre3-dev -y sshpass -y
```

### Part 2. Building

![конфигурация стадии build в yml файле](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%204.png)

конфигурация стадии build в yml файле

![Стадия build прошла успешно](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%205.png)

Стадия build прошла успешно

![Лог build джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%206.png)

Лог build джобы

### Part 3. Codestyle test

![Искусственно создаем стилевую ошибку
](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%207.png)

Искусственно создаем стилевую ошибку

![Job по проверке на стиль зафейлилась (согласно заданию)](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%208.png)

Job по проверке на стиль зафейлилась (согласно заданию)

![Style formatting does not match… - лог из style джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%209.png)

Style formatting does not match… - лог из style джобы

![Job по проверке на стиль прошла с успехом (после исправлений кода по стилю)](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2010.png)

Job по проверке на стиль прошла с успехом (после исправлений кода по стилю)

![No style warnings found in any file - лог из style джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2011.png)

No style warnings found in any file - лог из style джобы

![конфигурация стадии style в yml файле](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2012.png)

конфигурация стадии style в yml файле

### Part 4. Integration tests

![Job по проверке на unit тесты зафейлилась (согласно заданию)](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2013.png)

Job по проверке на unit тесты зафейлилась (согласно заданию)

![Интеграционные тесты не прошли - лог из test джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2014.png)

Интеграционные тесты не прошли - лог из test джобы

![Job по проверке на unit тесты прошла успешно (после исправления ошибки, намеренно сделанной в тесте)](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2015.png)

Job по проверке на unit тесты прошла успешно (после исправления ошибки, намеренно сделанной в тесте)

![Все интеграционные тесты прошли успешно - лог из test джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2016.png)

Все интеграционные тесты прошли успешно - лог из test джобы

![конфигурация стадии test в yml файле](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2017.png)

конфигурация стадии test в yml файле

### Part 5. Deployment stage

![Вторая машина с убунту 22.04 поднятa](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2018.png)

Вторая машина с убунту 22.04 поднятa

![Проверяем адреса с помощью **ip a**](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2019.png)

Проверяем адреса с помощью **ip a**

![Создаем ssh ключ с помощью **ssh-keygen -t rsa -b 2048** и копируем ключ на вторую ВМ](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2020.png)

Создаем ssh ключ с помощью **ssh-keygen -t rsa -b 2048** и копируем ключ на вторую ВМ

![Даем права пользователю на папку, куда будут залиты cat и grep](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2021.png)

Даем права пользователю на папку, куда будут залиты cat и grep

![Проверяем, что в папке нет cat и grep](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2022.png)

Проверяем, что в папке нет cat и grep

![Сканируем ssh ключи с порта второй ВМ и копируем их в known_hosts](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2023.png)

Сканируем ssh ключи с порта второй ВМ и копируем их в known_hosts

![Даем права на mv без запроса пароля](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2024.png)

Даем права на mv без запроса пароля

![После ручного запуска деплоя, джоба отработала успешно](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2025.png)

После ручного запуска деплоя, джоба отработала успешно

![Лог джобы deploy](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2026.png)

Лог джобы deploy

![Проверяем наличие cat и grep в целевой папке](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2027.png)

Проверяем наличие cat и grep в целевой папке

### Part 6. Bonus. Notifications

![Создаем бота с помощью BotFather](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2028.png)

Создаем бота с помощью BotFather

![Называем согласно заданию и получаем токен для API](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2029.png)

Называем согласно заданию и получаем токен для API

Далее:

- С помощью бота Get My ID получаем user ID.
- Добавляем в jobы в yml after_script и команды для запуска скрипта нотификаций
- Создаем скрипт notify_bot.sh
- Пушим изменения и запускается пайплайн с нотификациями (скрины ниже)

![В случае неуспеха стоит соответствующий статус и нет гифки](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2030.png)

В случае неуспеха стоит соответствующий статус и нет гифки

![В случае успеха - зеленая галочка и тематическая гифка в зависимости от джобы](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2031.png)

В случае успеха - зеленая галочка и тематическая гифка в зависимости от джобы

![После перехода по ссылки и мануального запуска деплоя, тоже приходит уведомление](CICD%20ce3fed91822c4e44a411f92108d92094/Untitled%2032.png)

После перехода по ссылки и мануального запуска деплоя, тоже приходит уведомление